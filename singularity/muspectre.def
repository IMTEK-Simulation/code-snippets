Bootstrap: localimage
From: io.sif

%post

    if [ -e /usr/share/modulefiles ]; then
        export MODULEPATH=/usr/share/modulefiles
        source /usr/share/lmod/lmod/init/bash
        module load mpi
    fi

    if $(command -v dnf); then
        dnf install -y boost-devel
    else
        apt-get -y -qq libboost-test-dev
    fi

    # Install muSpectre
    export MUSPECTRE_DIR=/opt/muSpectre
    export MUSPECTRE_BRANCH=merge/21_even_grid_points
    git clone -b ${MUSPECTRE_BRANCH} https://gitlab.com/muspectre/muspectre.git ${MUSPECTRE_DIR}
    cd ${MUSPECTRE_DIR}
    python3 -m pip install -r requirements.txt
    python3 -m pip install NuMPI
    cd build
    # NEMO is Sandy Bridge
    cmake -DCMAKE_VERBOSE_MAKEFILE=ON -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_FLAGS_RELEASE="-O2 -march=sandybridge -mno-avx512f" -DCMAKE_CXX_FLAGS_RELEASE="-O2 -march=sandybridge -mno-avx512f" -DMUSPECTRE_MPI_PARALLEL=ON -DNETCDF_IO=ON ..
    make -j 4
    make install

%runscript 

    python3 "$@"
